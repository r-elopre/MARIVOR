{% extends "base.html" %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <div class="fs-1 text-success mb-3">✉️</div>
                        <h2 class="fw-bold">Verify Your Phone</h2>
                        <p class="text-muted">
                            We sent a 6-digit code to<br>
                            <strong>+63{{ phone_number }}</strong>
                        </p>
                    </div>

                    <!-- OTP Verification Form -->
                    <form id="otpForm" action="{{ url_for('verify_otp') }}" method="POST">
                        <input type="hidden" name="phone_number" value="{{ phone_number }}">
                        
                        <div class="mb-4">
                            <label for="otp_code" class="form-label fw-semibold">Verification Code</label>
                            <input type="text" 
                                   class="form-control form-control-lg text-center fs-4" 
                                   id="otp_code" 
                                   name="otp_code" 
                                   placeholder="000000"
                                   pattern="[0-9]{6}" 
                                   maxlength="6"
                                   autocomplete="off"
                                   required>
                            <div class="form-text text-center">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    Enter the 6-digit code from your SMS
                                </small>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success btn-lg" id="verifyBtn">
                                <i class="bi bi-check-circle-fill"></i> Verify Code
                            </button>
                            
                            <!-- Resend Option -->
                            <div class="text-center mt-3">
                                <span class="text-muted">Didn't receive the code?</span>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-outline-primary" id="resendBtn" onclick="resendOTP()">
                                        <i class="bi bi-arrow-clockwise"></i> Resend Code
                                    </button>
                                    <span id="countdown" class="ms-2 text-muted"></span>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Back to Phone Entry -->
                    <div class="text-center mt-4">
                        <a href="{{ url_for('login') }}" class="btn btn-link">
                            <i class="bi bi-arrow-left"></i> Use different phone number
                        </a>
                    </div>

                    <!-- Security Notice -->
                    <div class="alert alert-warning mt-4" role="alert">
                        <div class="d-flex">
                            <div class="me-2">
                                <i class="bi bi-shield-exclamation"></i>
                            </div>
                            <div>
                                <strong>Security Notice:</strong><br>
                                <small>
                                    Your code expires in <strong>5 minutes</strong>. 
                                    Don't share this code with anyone.
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Attempts Warning -->
                    {% if attempts_left %}
                        <div class="alert alert-danger" role="alert">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Warning:</strong> {{ attempts_left }} attempts remaining.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let resendCooldown = 60; // 60 seconds cooldown
let countdownTimer;

// Auto-format OTP input
document.getElementById('otp_code').addEventListener('input', function(e) {
    // Remove any non-digit characters
    let value = e.target.value.replace(/\D/g, '');
    
    // Limit to 6 digits
    if (value.length > 6) {
        value = value.substring(0, 6);
    }
    
    e.target.value = value;
    
    // Auto-submit when 6 digits are entered
    if (value.length === 6) {
        document.getElementById('otpForm').submit();
    }
});

// Form submission handling
document.getElementById('otpForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('verifyBtn');
    const otpInput = document.getElementById('otp_code');
    
    // Validate OTP format
    const otp = otpInput.value.trim();
    if (!/^[0-9]{6}$/.test(otp)) {
        e.preventDefault();
        alert('Please enter a valid 6-digit verification code');
        otpInput.focus();
        return;
    }
    
    // Show loading state
    btn.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Verifying...';
    btn.disabled = true;
});

// Resend OTP function
function resendOTP() {
    const resendBtn = document.getElementById('resendBtn');
    const phoneNumber = document.querySelector('input[name="phone_number"]').value;
    
    // Disable resend button and start countdown
    resendBtn.disabled = true;
    startCountdown();
    
    // Send AJAX request to resend OTP
    fetch('/send_otp', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'phone_number=' + encodeURIComponent(phoneNumber) + '&resend=true'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('New verification code sent!');
        } else {
            alert('Failed to resend code. Please try again.');
            resendBtn.disabled = false;
            clearInterval(countdownTimer);
            document.getElementById('countdown').textContent = '';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to resend code. Please try again.');
        resendBtn.disabled = false;
        clearInterval(countdownTimer);
        document.getElementById('countdown').textContent = '';
    });
}

// Countdown timer for resend button
function startCountdown() {
    let timeLeft = resendCooldown;
    const countdownElement = document.getElementById('countdown');
    const resendBtn = document.getElementById('resendBtn');
    
    countdownTimer = setInterval(function() {
        countdownElement.textContent = `(${timeLeft}s)`;
        timeLeft--;
        
        if (timeLeft < 0) {
            clearInterval(countdownTimer);
            countdownElement.textContent = '';
            resendBtn.disabled = false;
        }
    }, 1000);
}

// Focus on OTP input when page loads
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('otp_code').focus();
});

// Handle paste event for OTP
document.getElementById('otp_code').addEventListener('paste', function(e) {
    setTimeout(function() {
        const pastedValue = e.target.value.replace(/\D/g, '').substring(0, 6);
        e.target.value = pastedValue;
        
        if (pastedValue.length === 6) {
            document.getElementById('otpForm').submit();
        }
    }, 10);
});
</script>
{% endblock %}